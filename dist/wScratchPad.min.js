class wScratchPad{constructor(t,s){this.$el=t,this.options=s;this.options=Object.assign({size:30,fg:"#ccc",realtime:!0,scratchDown:null,scratchUp:null,scratchMove:null,cursor:"crosshair"},this.options),this.init=!1,this.enabled=!0,this._generate()}_generate(){if(document.createElement("canvas").getContext){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.$el.style.position="relative",this.$img=document.createElement("img"),this.$img.style.position="absolute",this.$img.style.width="100%",this.$img.style.height="100%",this.canvas.style.position="absolute",this.canvas.style.width="100%",this.canvas.style.height="100%",this.$scratchpad=this.canvas,this._bindMobileEvents(this.$scratchpad);var t=this;this.$scratchpad.addEventListener("mousedown",function(s){if(t.enabled){var e=t.canvas.getBoundingClientRect();t.canvasOffset={top:e.top+document.body.scrollTop,left:e.left+document.body.scrollLeft},t.scratch=t,t._scratchFunc(s,"Down")}}),this.$scratchpad.addEventListener("mousemove",function(s){t.scratch&&t._scratchFunc(s,"Move")}),document.addEventListener("mouseup",function(s){t.scratch&&(t.scratch=!1,t._scratchFunc(s,"Up"))}),this._setOptions(),this.$el.appendChild(this.$scratchpad),this.init=!0,this.reset()}else this.$el.innerHTML="Canvas is not supported in this browser."}reset(){var t=this,s=Math.ceil(this.$el.offsetWidth),e=Math.ceil(this.$el.offsetHeight),i=window.devicePixelRatio||1;if(this.pixels=s*e,this.$scratchpad.style.width=s,this.$scratchpad.style.height=e,this.canvas.setAttribute("width",s*i),this.canvas.setAttribute("height",e*i),this.ctx.scale(i,i),this.pixels=s*i*e*i,this.$img.style.display="none",this.options.bg&&("#"===this.options.bg.charAt(0)?this.$el.style.backgroundColor=this.options.bg:(this.$el.style.backgroundColor=null,this.$img.src=this.options.bg)),this.options.fg)if("#"===this.options.fg.charAt(0))this.ctx.fillStyle=this.options.fg,this.ctx.beginPath(),this.ctx.rect(0,0,s,e),this.ctx.fill(),this.$img.style.display="block";else{let i=new Image;i.addEventListener("load",function(){t.ctx.drawImage(this,0,0,s,e),t.$img.style.display="block"}),i.src=this.options.fg,i.crossOrigin=""}}clear(){this.ctx.clearRect(0,0,Math.ceil(this.$el.offsetWidth),Math.ceil(this.$el.offsetHeight))}enable(t){this.enabled=!0===t}destroy(){this.$el.empty(),this.removeData(this.$el,"wScratchPad")}_setOptions(){var t,s;for(t in this.options)this.options[t]=this.$el.getAttribute("data-"+t)||this.options[t],this[s="set"+t.charAt(0).toUpperCase()+t.substring(1)]&&this[s](this.options[t])}setBg(){this.init&&this.reset()}setFg(){this.setBg()}setCursor(t){this.$el.style.cursor=t}_scratchFunc(t,s){let e=Object.assign({},t);e.pageX=Math.floor(t.pageX-this.canvasOffset.left),e.pageY=Math.floor(t.pageY-this.canvasOffset.top),this["_scratch"+s](e),(this.options.realtime||"Move"===s)&&this.options["scratch"+s]&&this.options["scratch"+s].apply(this,[e,this._scratchPercent()])}_scratchPercent(){for(var t=0,s=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height),e=0,i=s.data.length;e<i;e+=4)0===s.data[e]&&0===s.data[e+1]&&0===s.data[e+2]&&0===s.data[e+3]&&t++;return t/this.pixels*100}_scratchDown(t){this.ctx.globalCompositeOperation="destination-out",this.ctx.lineJoin="round",this.ctx.lineCap="round",this.ctx.strokeStyle=this.options.color,this.ctx.lineWidth=this.options.size,this.ctx.beginPath(),this.ctx.arc(t.pageX,t.pageY,this.options.size/2,0,2*Math.PI,!0),this.ctx.closePath(),this.ctx.fill(),this.ctx.beginPath(),this.ctx.moveTo(t.pageX,t.pageY)}_scratchMove(t){this.ctx.lineTo(t.pageX,t.pageY),this.ctx.stroke()}_scratchUp(){this.ctx.closePath()}_bindMobileEvents(t){let s=this;t.addEventListener("touchstart",function(t){s._handleMobile(t)}),t.addEventListener("touchmove",function(t){s._handleMobile(t)}),t.addEventListener("touchend",function(t){s._handleMobile(t)}),t.addEventListener("touchcancel",function(t){s._handleMobile(t)})}_handleMobile(t){var s=(t.changedTouches||t.originalEvent.targetTouches)[0],e="";switch(t.type){case"touchstart":t.preventDefault(),e="mousedown";break;case"touchmove":e="mousemove",t.preventDefault();break;case"touchend":e="mouseup";break;default:return}var i=document.createEvent("MouseEvent");i.initMouseEvent(e,!0,!0,window,1,s.screenX,s.screenY,s.clientX,s.clientY,!1,!1,!1,!1,0,null),s.target.dispatchEvent(i)}}